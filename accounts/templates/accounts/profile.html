{% extends 'base.html' %} 
{% load static %} 
{% block content %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}" />

  <div class="all">
    <div class="container mt-5">

      <!-- 헤더 -->
      <div class=" main">
        <div class="d-flex justicy-content-center">
          <!-- 프로필 사진 -->
          <div class="main_1">
            <form id="edit-profile-form">
              {% csrf_token %}
              <label for="image-upload" class="image-upload-label">
                {% if person.profile_image %}
                  <img src="{{ person.profile_image.url }}" alt="post_image" id="profile-image2">
                {% else %}
                  <img class="pro_main_img" id="profile-image" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSLIbLTGKz4waJGU2vkbhQkRavjf2OdeY7Eo4l8yFnggdF3fX1bUF4FEUP13o34ioSCm-M&usqp=CAU" alt="">
                {% endif %}
              </label>
              <input type="file" id="image-upload" name="profile_image" style="display: none" accept="image/*">
            </form>
          </div>

          <!-- 프로필 정보 & 버튼 -->
          <div class="d-flex main_2 mt-5">
            <!-- 아이디 -->
            <h2 style="font-size: 30px; font-weight: 600;">{{ person }}</h2>

            <div class="d-grid gap-2 d-md-block">

              <!-- 팔로우 버튼 -->
              {% if request.user != person %}
              <form id="follow-form" data-user-id="{{ person.pk }}">
                {% csrf_token %}
                {% if request.user in person.followers.all %}
                <input type="submit" value='언팔로우' class="btn btn-sm button btn-outline-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
                {% else %}
                <input type="submit" value='팔로우' class="btn btn-sm  button btn-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
                {% endif %}
              </form>
              {% endif %}
              {% if request.user == person %}
                <a href="{% url 'accounts:edit' %}" value="프로필 편집" class="btn button btn-secondary">프로필 편집</a>
              {% endif %}
              {% comment %} <button id="followButton" class="btn button btn-primary" type="button">팔로우</button> {% endcomment %}
            </div>
          </div>
        </div>

        <!-- 프로필 게시물 갯수 & 팔로워명 & 팔로우명 -->
        <div class="main_3">
          <ul>
            <!-- 게시물 갯수 -->
            <li> 
              <span>게시물</span>
              <span>{{ person.post_set|length }}</span>
            </li>
            <!-- 팔로워 인원 -->
            <li>
              <button style = "font-size:16px" type="button" class="btn btn-sm me-1 btn-white" data-bs-toggle="modal" data-bs-target="#followings" id="follow">
                팔로잉
                <span id="followings-count">{{ person.followings.all|length }}</span>
              </button>
            </li>
            <!-- 팔로우 인원 -->
            <li>
              <button style = "font-size:16px" type="button" class="btn btn-sm " data-bs-toggle="modal" data-bs-target="#followers" id="follow">
                팔로우
                <span id="followers-count">{{ person.followers.all|length }}</span>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <hr>
    <div class="container2">

      <!-- 이미지 -->
      <div class="image_coll">
        <ul>
        {% for post in person.post_set.all %}
          <li>
            {% if post.post_images.first.image.url %}
              <a href="{% url 'posts:detail' post.pk %}" style="color:#198754; text-decoration: none;">
                <img style="width: 14rem; height: 11rem; max-width: 100%;max-height: 100%;"class='imgs_main' src=" {{ post.post_images.first.image.url }} " alt="movie_img">
              </a>
            {% else %}
              <a href="{% url 'posts:detail' post.pk %}" style="color:#198754; text-decoration: none;">
                <img style="width: 14rem; height: 11rem; max-width: 100%;max-height: 100%;" class='imgs_main' src="{% static 'no_image.jpg' %}" alt="no_img">
              </a>
            {% endif %}
          </li>
        {% endfor %}
        
        </ul>
      </div>

    </div>
    <div class="modal fade" id="followings" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-4" id="followingsModalLabel">팔로잉</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            {% for following in person.followings.all %}
              <a href="{% url 'accounts:profile' following %}" class="link-dark link-underline link-underline-opacity-0 fs-5">{{ following }}</a>
              {% if request.user != person %}
              <form id="followform2" data-user-id="{{ person.pk }}">
                {% csrf_token %}
                {% if request.user in person.followers.all %}
                <input type="submit" value='언팔로우' class="btn btn-sm btn-outline-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
                {% else %}
                <input type="submit" value='팔로우' class="btn btn-sm btn-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
                {% endif %}
              </form>
              {% endif %}
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
          </div>
        </div>
      </div>
    </div>
    
    {% comment %} 팔로우 팔로잉 목록 모달 {% endcomment %}
    <div class="modal fade" id="followers" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-4" id="followersModalLabel">팔로우</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            {% for follower in person.followers.all %}
            <a href="{% url 'accounts:profile' follower %}" class="link-dark link-underline link-underline-opacity-0 fs-5">{{ follower }}</a>
            {% if request.user == person %}
            <form id="followform2" data-user-id="{{ person.pk }}">
              {% csrf_token %}
              {% if request.user in person.followers.all %}
              <input type="submit" value='언팔로우' class="btn btn-sm btn-outline-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
              {% else %}
              <input type="submit" value='팔로우' class="btn btn-sm btn-primary" {% if not request.user.is_authenticated %}disabled{% endif %}>
              {% endif %}
            </form>
            {% endif %}
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script type='text/javascript' src="{% static 'js/followform.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>

  <!-- 팔로잉 팔로우 js -->
  <script>
  // Get the button element
    {% comment %} const followButton = document.getElementById('followButton');

    // Add click event listener to the button
    followButton.addEventListener('click', function () {
      // Toggle the button text between "팔로우" and "팔로잉"
      if (followButton.innerText === '팔로우') {
        followButton.innerText = '팔로잉';
        followButton.classList.add('following'); // Add CSS class for gray color
      } else {
        followButton.innerText = '팔로우';
        followButton.classList.remove('following'); // Remove CSS class for gray color
      }
    }); {% endcomment %}


  </script>

  <script>
    {% comment %} const imageUpload = document.getElementById('image-upload');
    const profileImage = document.getElementById('profile-image');
  
    imageUpload.addEventListener('change', function() {
      const file = imageUpload.files[0];
      const reader = new FileReader();
  
      reader.addEventListener('load', function() {
        profileImage.src = reader.result;
      });
  
      if (file) {
        reader.readAsDataURL(file);
      }
    }); {% endcomment %}
  </script>
  <script>
    const editProfileForm = document.querySelector("#edit-profile-form");
    const profileImage = document.querySelector("#profile-image2");
    const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    const userId = "{{ user.pk }}";
    const handleFileSelect = (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const imageData = new FormData();
        imageData.append("csrfmiddlewaretoken", csrfToken);
        imageData.append("profile_image", file);
        axios
          .post(`/accounts/profile/update_image/${userId}/`, imageData)
          .then((response) => {
            profileImage.src = response.data.profile_image_url;
            console.log(response.data.profile_image_url)
          })
          .catch((error) => {
            console.error(error);
          });
      };
      reader.readAsDataURL(file);
    };
    
    editProfileForm.addEventListener("change", handleFileSelect);
  </script>
  {% endblock content %}